window.FOO="TEST",function(){"use strict";class e{constructor(e){this._observable=e}get observable(){return this._observable}}class t{constructor(e,t,n){this._observable=e,this._eventName=t,this._callback=n}remove(){this._observable.removeListener(this)}get eventName(){return this._eventName}get callback(){return this._callback}}class n{constructor(){this._listeners={}}listen(e,n,i=!1){Array.isArray(this._listeners[e])||(this._listeners[e]=[]);const r=new t(this,e,n);return i?this._listeners[e].unshift(r):this._listeners[e].push(r),r}removeListener(e){this._listeners[e.eventName]=this._listeners[e.eventName].filter((t=>t!==e))}emit(e,t){if(Array.isArray(this._listeners[e]))for(const n of this._listeners[e].slice())n.callback(t)}}class i{constructor(t,i=new e(new n)){this._identifier={},this._properties={...t},this._parent=null,this._root=null,this._model=null,this._children=[],this._listeners=[],this._eventListener=i}get identifier(){return this._identifier}get properties(){return this._properties}get root(){return this._root}get model(){return this._model}get eventListener(){return this._eventListener}listen(e,t,n,i=!1){const r=e.listen(t,n,i);return i?this._listeners.unshift(r):this._listeners.push(r),r}run(e,t){t.binding._parent=this,this._children.push(t.binding),t.binding._properties={...this.properties,...t.binding.properties},s.run(e,{parentNode:this.root,...t})}remove(){const e=this._listeners.slice();for(const t of e)t.remove();const t=this._children.slice();for(const e of t)e.remove();null!==this._parent&&(this._parent._children=this._parent._children.filter((e=>e!==this))),this.root.remove()}onCreated(){}async onRendered(){}}class r{static PROPERTIES=["tagName","children","identifier","model","binding","properties"];static METHOD={APPEND_CHILD:"APPEND_CHILD",INSERT_BEFORE:"INSERT_BEFORE",REPLACE_NODE:"REPLACE_NODE",WRAP_NODE:"WRAP_NODE",PREPEND:"PREPEND"};static run(e,{parentNode:t,binding:n=new i,method:s=r.METHOD.APPEND_CHILD}={}){const a=r.createNode(t,e,n);n._root=a,n._model=e;for(const e of Object.getOwnPropertyNames(Object.getPrototypeOf(n.eventListener)).filter((e=>"constructor"!==e&&"function"==typeof n.eventListener[e])))n.listen(n.eventListener.observable,e,n.eventListener[e].bind(n),!0);n.onCreated(),s===r.METHOD.APPEND_CHILD?t.appendChild(a):s===r.METHOD.INSERT_BEFORE?t.parentNode.insertBefore(a,t):s===r.METHOD.REPLACE_NODE?t.replaceWith(a):s===r.METHOD.WRAP_NODE?(a.appendChild(t.cloneNode(!0)),t.replaceWith(a)):s===r.METHOD.PREPEND&&t.prepend(a),n.onRendered()}static createNode(e,t,n){const{tagName:i,children:s=[]}=t;let a;a=i?e.ownerDocument.createElement(i):e.ownerDocument.createDocumentFragment(),Object.keys(t).filter((e=>!1===r.PROPERTIES.includes(e))).forEach((function(e){a[e]=t[e]}));for(const t of s)if(!0===Object.prototype.hasOwnProperty.call(t,"model")){let e;!0===Object.prototype.hasOwnProperty.call(t,"binding")&&(e=new t.binding({...n.properties,...t.properties}),!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(n.identifier[t.identifier]=e)),n.run(t.model,{parentNode:a,binding:e})}else{const i=r.createNode(e,t,n);a.appendChild(i)}return!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(n.identifier[t.identifier]=a),a}}var s=r;class a extends n{constructor(e){super(),this._number=e,this._days=[]}get number(){return this._number}get days(){return this._days}}class d extends n{constructor(e,t=!1){super(),this._date=e,this._nextOrPreviousMonth=t;const n=new Date;this._today=e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()&&e.getFullYear()===n.getFullYear()}get date(){return this._date}get nextOrPreviousMonth(){return this._nextOrPreviousMonth}get today(){return this._today}}class o extends n{constructor(e,t){super(),this._title=e,this._date=t}get title(){return this._title}set title(e){this._title=e}get date(){return this._date}}class l extends n{constructor(){super(),this._list=[]}add(e,t){const n=new o(e,t);return this.list.push(n),n}remove(e){this._list=this.list.filter((t=>t!==e))}update(e,t){for(const n in t)e[n]=t[n]}byDate(e){return this.list.filter((t=>t.date.getMonth()===e.getMonth()&&t.date.getFullYear()===e.getFullYear()&&t.date.getDate()===e.getDate()))}next(){const e=new Date;return this.list.filter((t=>t.date.getTime()>=e.getTime()&&t.title&&""!==t.title.trim()))}clear(){this._list=[]}get list(){return this._list}toString(){return JSON.stringify(this.list.map((e=>({title:e.title,date:e.date}))))}}class c extends n{constructor(e){super(),this._date=e,this._weeks=[],this._day=null,this._events=new l,this.build(e)}getDayByDate(e){return this.weeks.map((e=>e.days)).flat().find((t=>t.date.getDate()===e.getDate()&&t.date.getMonth()===e.getMonth()))}build(e){this.weeks=[];const t=new Date(e.getFullYear(),e.getMonth()+1,0).getDate(),n=new Date(e.getFullYear(),e.getMonth()),i=[...Array(t).keys()];let r=new a(1);for(let t=n.getDay();t>0;t--){const n=new Date(e);n.setMonth(e.getMonth()-1);const i=new Date(n.getFullYear(),n.getMonth()+1,0).getDate();n.setDate(i-t+1),r.days.push(new d(n,!0))}for(let t=1;t<i.length+1;t++){const n=new Date(e);n.setDate(t),r.days.push(new d(n)),7!==r.days.length&&t!==i.length||(this.weeks.push(r),r=new a(r.number+1))}const s=this.weeks[this.weeks.length-1],o=7-s.days.length;for(let t=0;t<o;t++){const n=new Date(e);n.setMonth(e.getMonth()+1),n.setDate(t+1),s.days.push(new d(n,!0))}}setDate(e){this.date=e,this.day=this.getDayByDate(e)}addEvent(e,t){return this.events.add(e,t)}removeEvent(e){return this.events.remove(e)}updateEvent(e,t){return this.events.update(e,t)}hasEvent(e){return this.events.byDate(e).length>=1}getNextEvents(){return this.events.next()}get date(){return this._date}set date(e){this._date=e}get day(){return this._day}set day(e){this._day=e}get weeks(){return this._weeks}set weeks(e){this._weeks=e}get events(){return this._events}}class h extends n{constructor(e=new Date){super(),this._calendar=new c(e),this._firstRun=!0}get calendar(){return this._calendar}get editor(){return this._editor}get firstRun(){return this._firstRun}set firstRun(e){this._firstRun=e}}var p={tagName:"div",className:"date-browser",children:[{tagName:"div",children:[{tagName:"button",identifier:"today",textContent:"Today"}]},{tagName:"div",className:"controls",children:[{tagName:"div",children:[{tagName:"button",identifier:"previousMonth",textContent:"Previous month"},{tagName:"select",identifier:"month",children:["January","February","March","April","May","June","July","August","September","October","November","December"].map(((e,t)=>({tagName:"option",value:t+1,textContent:e})))},{tagName:"button",identifier:"nextMonth",textContent:"Next month"}]},{tagName:"input",type:"number",identifier:"year"}]}]};var u={tagName:"div",id:"calendar",children:[{tagName:"h2",identifier:"date",id:"date"},{model:p,binding:class extends i{onCreated(){const{planner:e}=this.properties,{calendar:t}=e;t.listen("setDate",(e=>{const t=new Date(e.date);this.identifier.month.selectedIndex=t.getMonth(),this.identifier.year.value=t.getFullYear()})),this.identifier.today.addEventListener("click",(()=>t.emit("setDate",{date:new Date}))),this.identifier.month.addEventListener("change",(()=>t.emit("setDate",{date:this.getCurrentMonthDate(),rebuild:!0}))),this.identifier.previousMonth.addEventListener("click",(()=>t.emit("setDate",{date:this.getPreviousMonthDate(),rebuild:!0}))),this.identifier.nextMonth.addEventListener("click",(()=>t.emit("setDate",{date:this.getNextMonthDate(),rebuild:!0}))),this.identifier.year.addEventListener("input",(e=>t.emit("setYear",e.target.value)))}getDateByMonthIndex(e){const t=this.properties.planner.calendar.date;return e>this.identifier.month.options.length-1?(e=0,t.setYear(parseInt(this.identifier.year.value)+1)):e<0&&(e=0,t.setYear(this.identifier.year.value-1)),t.setMonth(e),t}getNextMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex+1)}getPreviousMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex-1)}getCurrentMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex)}}},{tagName:"div",id:"day-headers",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((e=>({tagName:"div",className:"day-header padding-2xs",textContent:e})))},{tagName:"div",identifier:"weeks",id:"weeks"}]},v={className:"week",tagName:"div"},m={tagName:"div",className:"events"},g=e=>({tagName:"div",className:"event",children:[{tagName:"div",className:"editor",contentEditable:!0,identifier:"editor",textContent:e.title,children:[{tagName:"br"},{tagName:"input",style:"width: 100%; margin-top: 10px",identifier:"time",type:"time"}]}]});class f extends e{removed(){this.remove()}}class y extends i{constructor(e){super(e,new f(e.event))}onCreated(){const{planner:e,day:t}=this.properties;this.identifier.editor.addEventListener("input",(()=>{e.calendar.events.emit("update",{event:this.properties.event,form:{title:this.identifier.editor.textContent},day:t})})),this.identifier.time.addEventListener("input",(n=>{const i=n.target.valueAsDate;i.setMonth(t.date.getMonth()),i.setDate(t.date.getDate()),i.setYear(t.date.getYear()),e.calendar.events.emit("update",{event:this.properties.event,form:{date:i},day:t})}))}onRendered(){this.identifier.editor.focus()}}class D extends e{add(e){if(this.properties.day===e.day){const t=this.properties.planner.calendar.addEvent(e.title,e.date);this.run(g(t),{binding:new y({event:t})}),this.properties.planner.calendar.events.emit("added",{event:t,day:e.day})}}remove(e){this.properties.planner.calendar.removeEvent(e.event),e.event.emit("removed"),this.properties.planner.calendar.events.emit("removed",{event:e.event,day:e.day})}update(e){this.properties.planner.calendar.updateEvent(e.event,e.form),e.event.emit("updated"),this.properties.planner.calendar.events.emit("updated",{event:e.event,day:e.day})}clear(){for(const e of this.properties.planner.calendar.events.list){const t=this.properties.planner.calendar.getDayByDate(e.date);this.properties.planner.calendar.events.emit("remove",{event:e,day:t})}}added(e){e.day.emit("eventAdded")}removed(e){e.day&&e.day.emit("eventRemoved")}updated(e){e.day.emit("eventUpdated")}}class _ extends i{constructor(e){super(e,new D(e.planner.calendar.events))}onCreated(){const{planner:e,day:t}=this.properties;this.root.addEventListener("click",(n=>{n.target===this.root&&e.calendar.events.emit("add",{date:t.date,title:"",day:t})}));for(const n of e.calendar.events.byDate(t.date))this.run(g(n),{binding:new y({event:n})})}}var w=e=>({tagName:"div",className:`day${e.today?" current":""}${e.nextOrPreviousMonth?" grayed":""}`,children:[{tagName:"div",className:"date",textContent:e.date.getDate()},{model:m,binding:_}]});class E extends e{eventAdded(){this.root.classList.add("content")}eventRemoved(){this.properties.planner.calendar.hasEvent(this.properties.day.date)||this.root.classList.remove("content")}select(){this.root.classList.add("active")}unselect(){this.root.classList.remove("active")}}class N extends i{constructor(e){super(e,new E(e.day))}onCreated(){const{planner:e,day:t}=this.properties;e.calendar.hasEvent(t.date)&&this.root.classList.add("content"),this.root.addEventListener("click",(()=>{e.calendar.emit("setDate",{date:t.date})}))}}class x extends e{removed(){this.remove()}}class b extends i{constructor(e){super(e,new x(e.week))}onCreated(){const{planner:e,week:t}=this.properties;for(const e of t.days)this.run(w(e),{binding:new N({day:e})})}}class L extends e{setDate(e){const{planner:t}=this.properties,{calendar:n}=t,i=new Date(e.date);if(this.identifier.date.textContent=i.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),n.date.getMonth()!==i.getMonth()||n.date.getFullYear()!==i.getFullYear()||0===n.weeks.length||e.rebuild){null!==n.weeks&&n.weeks.forEach((e=>e.emit("removed"))),n.build(i);for(const e of n.weeks)this.run(v,{parentNode:this.identifier.weeks,binding:new b({week:e})})}else null!==n.weeks&&n.weeks.map((e=>e.days)).flat().forEach((e=>e.emit("unselect")));n.setDate(i),n.day.emit("select")}setYear(e){const{planner:t}=this.properties,{calendar:n}=t,i=new Date(n.date);i.setYear(e),n.emit("setDate",{date:i})}}class M extends e{updated(){this.identifier.title.textContent=this.properties.event.title}}class k extends i{constructor(e){super(e,new M(e.event))}onCreated(){this.properties}}var I=e=>({tagName:"div",id:"next-event",children:[{tagName:"div",identifier:"title",textContent:e.title},{tagName:"div",identifier:"date",textContent:e.date}]});class O extends e{added(e){this.run(I(e.event),{binding:new k({event:e.event})})}}var R={tagName:"div",id:"planner",children:[{tagName:"div",id:"navigation",identifier:"navigation",children:[{tagName:"button",textContent:"Export",identifier:"export"},{tagName:"button",textContent:"Import",identifier:"import"},{tagName:"button",textContent:"Calendar",identifier:"calendarButton"},{tagName:"button",textContent:"Next events",identifier:"nextEventsButton"}]},{identifier:"calendar",model:u,binding:class extends i{constructor(e){super(e,new L(e.planner.calendar))}onCreated(){const{planner:e}=this.properties,{calendar:t}=e;this.listen(e,"imported",(()=>{t.emit("setDate",{date:t.date,rebuild:!0})})),t.emit("setDate",{date:t.date,rebuild:!0})}}},{identifier:"nextEvents",model:{tagName:"div",id:"next-events",style:"display: none"},binding:class extends i{constructor(e){super(e,new O(e.planner.calendar.events))}onCreated(){const{planner:e}=this.properties;for(const t of e.calendar.getNextEvents())this.run(I(t),{binding:new k({event:t})})}}}]};class C extends e{export(){const{planner:e}=this.properties;null!==this.textFileURL&&this.root.ownerDocument.defaultView.URL.revokeObjectURL(this.textFileURL);const t=new Blob([e.calendar.events.toString()],{type:"text/plain"}),n=new Date;this.textFileURL=URL.createObjectURL(t);const i=this.root.ownerDocument.createElement("a");i.href=this.textFileURL,i.download=`backup-domodel-planner-${n.getMonth()+1}-${n.getDate()}-${n.getFullYear()}.txt`,i.click(),e.emit("exported")}import(){const{planner:e}=this.properties,t=this.root.ownerDocument.createElement("input");t.type="file",t.style.display="none",t.addEventListener("input",(n=>{const i=new FileReader;i.addEventListener("load",(()=>{try{const t=JSON.parse(i.result);e.calendar.events.emit("clear"),t.forEach((t=>e.calendar.events.add(t.title,new Date(t.date)))),e.emit("imported")}catch(e){console.error(e),alert("Unable to import this backup.")}})),i.addEventListener("error",(()=>alert("Error reading file"))),i.readAsText(n.target.files[0],"UTF-8"),t.remove()})),t.click()}openSettings(){this.popup.emit("show")}}class P extends i{static INACTIVITY_TIMER_DELAY=9e5;constructor(e){super(e,new C(e.planner)),this.textFileURL=null,this.interval=null,this.inactivity_timer_delay=this.properties.inactivity_timer_delay||P.INACTIVITY_TIMER_DELAY}onCreated(){const{planner:e}=this.properties;this.listen(e,"logout",(()=>{this.stopInactivityTimer()})),this.root.ownerDocument.defaultView.addEventListener("click",(()=>{this.restartInactivityTimer()})),this.root.ownerDocument.defaultView.addEventListener("input",(()=>{this.restartInactivityTimer()})),this.identifier.export.addEventListener("click",(()=>e.emit("export"))),this.identifier.import.addEventListener("click",(()=>e.emit("import"))),this.identifier.calendarButton.addEventListener("click",(()=>{this.identifier.calendar.root.style.display="",this.identifier.nextEvents.root.style.display="none"})),this.identifier.nextEventsButton.addEventListener("click",(()=>{this.identifier.calendar.root.style.display="none",this.identifier.nextEvents.root.style.display=""})),this.startInactivityTimer()}startInactivityTimer(){this.interval=this.root.ownerDocument.defaultView.setInterval((()=>this.properties.planner.emit("logout")),this.inactivity_timer_delay)}stopInactivityTimer(){this.root.ownerDocument.defaultView.clearInterval(this.interval)}restartInactivityTimer(){this.stopInactivityTimer(),this.startInactivityTimer()}}const T="events";function A(e){localStorage.setItem(T,e.calendar.events.toString())}var F=e=>{(e=>{const{planner:t}=e;if(t.firstRun=null===localStorage.getItem(T),!1===t.firstRun){const e=JSON.parse(localStorage.getItem(T));for(const n of e)t.calendar.addEvent(n.title,new Date(n.date))}localStorage.getItem("currentDate")&&(t.calendar.date=new Date(localStorage.getItem("currentDate"))),t.calendar.listen("setDate",(()=>localStorage.setItem("currentDate",t.calendar.date))),t.calendar.events.listen("added",(()=>A(t))),t.calendar.events.listen("removed",(()=>A(t))),t.calendar.events.listen("updated",(()=>A(t))),t.listen("imported",(()=>A(t)))})(e)};window.addEventListener("load",(function(){const e=new h;F({planner:e}),s.run(R,{binding:new P({planner:e}),parentNode:document.body})}))}();
