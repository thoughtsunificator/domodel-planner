window.FOO="TEST",function(){"use strict";class e{constructor(e){this._observable=e}get observable(){return this._observable}}class t{constructor(e,t,n){this._observable=e,this._eventName=t,this._callback=n}remove(){this._observable.removeListener(this)}get eventName(){return this._eventName}get callback(){return this._callback}}class n{constructor(){this._listeners={}}listen(e,n,i=!1){Array.isArray(this._listeners[e])||(this._listeners[e]=[]);const r=new t(this,e,n);return i?this._listeners[e].unshift(r):this._listeners[e].push(r),r}removeListener(e){this._listeners[e.eventName]=this._listeners[e.eventName].filter((t=>t!==e))}emit(e,t){if(Array.isArray(this._listeners[e]))for(const n of this._listeners[e].slice())n.callback(t)}}class i{constructor(t,i=new e(new n)){this._identifier={},this._properties={...t},this._parent=null,this._root=null,this._model=null,this._children=[],this._listeners=[],this._eventListener=i}get identifier(){return this._identifier}get properties(){return this._properties}get root(){return this._root}get model(){return this._model}get eventListener(){return this._eventListener}listen(e,t,n,i=!1){const r=e.listen(t,n,i);return i?this._listeners.unshift(r):this._listeners.push(r),r}run(e,t){t.binding._parent=this,this._children.push(t.binding),t.binding._properties={...this.properties,...t.binding.properties},s.run(e,{parentNode:this.root,...t})}remove(){const e=this._listeners.slice();for(const t of e)t.remove();const t=this._children.slice();for(const e of t)e.remove();null!==this._parent&&(this._parent._children=this._parent._children.filter((e=>e!==this))),this.root.remove()}onCreated(){}async onRendered(){}}class r{static PROPERTIES=["tagName","children","identifier","model","binding","properties"];static METHOD={APPEND_CHILD:"APPEND_CHILD",INSERT_BEFORE:"INSERT_BEFORE",REPLACE_NODE:"REPLACE_NODE",WRAP_NODE:"WRAP_NODE",PREPEND:"PREPEND"};static run(e,{parentNode:t,binding:n=new i,method:s=r.METHOD.APPEND_CHILD}={}){const a=r.createNode(t,e,n);n._root=a,n._model=e;for(const e of Object.getOwnPropertyNames(Object.getPrototypeOf(n.eventListener)).filter((e=>"constructor"!==e&&"function"==typeof n.eventListener[e])))n.listen(n.eventListener.observable,e,n.eventListener[e].bind(n),!0);n.onCreated(),s===r.METHOD.APPEND_CHILD?t.appendChild(a):s===r.METHOD.INSERT_BEFORE?t.parentNode.insertBefore(a,t):s===r.METHOD.REPLACE_NODE?t.replaceWith(a):s===r.METHOD.WRAP_NODE?(a.appendChild(t.cloneNode(!0)),t.replaceWith(a)):s===r.METHOD.PREPEND&&t.prepend(a),n.onRendered()}static createNode(e,t,n){const{tagName:i,children:s=[]}=t,a=e.ownerDocument.createElement(i);Object.keys(t).filter((e=>!1===r.PROPERTIES.includes(e))).forEach((function(e){a[e]=t[e]}));for(const t of s)if(!0===Object.prototype.hasOwnProperty.call(t,"model")){let e;!0===Object.prototype.hasOwnProperty.call(t,"binding")&&(e=new t.binding({...n.properties,...t.properties}),!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(n.identifier[t.identifier]=e)),n.run(t.model,{parentNode:a,binding:e})}else{const i=r.createNode(e,t,n);a.appendChild(i)}return!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(n.identifier[t.identifier]=a),a}}var s=r;class a extends n{constructor(e){super(),this._number=e,this._days=[]}get number(){return this._number}get days(){return this._days}}class o extends n{constructor(e,t=!1){super(),this._date=e,this._nextOrPreviousMonth=t;const n=new Date;this._today=e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()&&e.getFullYear()===n.getFullYear()}get date(){return this._date}get nextOrPreviousMonth(){return this._nextOrPreviousMonth}get today(){return this._today}}class d extends n{constructor(e,t){super(),this._title=e,this._date=t}get title(){return this._title}set title(e){this._title=e}get date(){return this._date}}class l extends n{constructor(){super(),this._list=[]}add(e,t){const n=new d(e,t);return this.list.push(n),n}remove(e){this.list.splice(this.list.indexOf(e),1)}update(e,t){for(const n in t)e[n]=t[n]}byDate(e){return this.list.filter((t=>t.date.getMonth()===e.getMonth()&&t.date.getFullYear()===e.getFullYear()&&t.date.getDate()===e.getDate()))}clear(){this._list=[]}get list(){return this._list}toString(){return JSON.stringify(this.list.map((e=>({title:e.title,date:e.date}))))}}class c extends n{constructor(e){super(),this._date=e,this._weeks=[],this._day=null,this._events=new l,this.build(e)}getDayByDate(e){return this.weeks.map((e=>e.days)).flat().find((t=>t.date.getDate()===e.getDate()&&t.date.getMonth()===e.getMonth()))}build(e){this.weeks=[];const t=new Date(e.getFullYear(),e.getMonth()+1,0).getDate(),n=new Date(e.getFullYear(),e.getMonth()),i=[...Array(t).keys()];let r=new a(1);for(let t=n.getDay();t>0;t--){const n=new Date(e);n.setMonth(e.getMonth()-1);const i=new Date(n.getFullYear(),n.getMonth()+1,0).getDate();n.setDate(i-t+1),r.days.push(new o(n,!0))}for(let t=1;t<i.length+1;t++){const n=new Date(e);n.setDate(t),r.days.push(new o(n)),7!==r.days.length&&t!==i.length||(this.weeks.push(r),r=new a(r.number+1))}const s=this.weeks[this.weeks.length-1],d=7-s.days.length;for(let t=0;t<d;t++){const n=new Date(e);n.setMonth(e.getMonth()+1),n.setDate(t+1),s.days.push(new o(n,!0))}}setDate(e){this.date=e,this.day=this.getDayByDate(e)}addEvent(e,t){return this.events.add(e,t)}get date(){return this._date}set date(e){this._date=e}get day(){return this._day}set day(e){this._day=e}get weeks(){return this._weeks}set weeks(e){this._weeks=e}get events(){return this._events}}class h extends n{constructor(e=new Date){super(),this._calendar=new c(e),this._firstRun=!0}get calendar(){return this._calendar}get editor(){return this._editor}get events(){return this._events}get firstRun(){return this._firstRun}set firstRun(e){this._firstRun=e}}var u={tagName:"div",className:"date-browser",children:[{tagName:"div",children:[{tagName:"button",identifier:"today",textContent:"↩️"}]},{tagName:"div",className:"controls",children:[{tagName:"div",children:[{tagName:"button",identifier:"previousMonth",textContent:"←"},{tagName:"select",identifier:"month",children:["January","February","March","April","May","June","July","August","September","October","November","December"].map(((e,t)=>({tagName:"option",value:t+1,textContent:e})))},{tagName:"button",identifier:"nextMonth",textContent:"→"}]},{tagName:"input",type:"number",identifier:"year"}]}]};var p={tagName:"div",id:"calendar",children:[{tagName:"h2",identifier:"date",id:"date"},{model:u,binding:class extends i{onCreated(){const{planner:e}=this.properties,{calendar:t}=e;t.listen("setDate",(e=>{const t=new Date(e.date);this.identifier.month.selectedIndex=t.getMonth(),this.identifier.year.value=t.getFullYear()})),this.identifier.today.addEventListener("click",(e=>t.emit("setDate",{date:new Date}))),this.identifier.month.addEventListener("change",(e=>t.emit("setDate",{date:this.getCurrentMonthDate(),rebuild:!0}))),this.identifier.previousMonth.addEventListener("click",(()=>t.emit("setDate",{date:this.getPreviousMonthDate(),rebuild:!0}))),this.identifier.nextMonth.addEventListener("click",(()=>t.emit("setDate",{date:this.getNextMonthDate(),rebuild:!0}))),this.identifier.year.addEventListener("input",(e=>t.emit("setYear",e.target.value)))}getDateByMonthIndex(e){const t=this.properties.planner.calendar.date;return e>this.identifier.month.options.length-1?(e=0,t.setYear(parseInt(this.identifier.year.value)+1)):e<0&&(e=0,t.setYear(this.identifier.year.value-1)),t.setMonth(e),t}getNextMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex+1)}getPreviousMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex-1)}getCurrentMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex)}}},{tagName:"div",id:"day-headers",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((e=>({tagName:"div",className:"day-header padding-2xs",textContent:e})))},{tagName:"div",identifier:"weeks",id:"weeks"}]},m={className:"week",tagName:"div"},g={tagName:"div",className:"events"},v=e=>({tagName:"div",className:"event",children:[{identifier:"remove",tagName:"div",className:"actions",children:[{tagName:"button",textContent:"⚙️"}]},{tagName:"div",className:"editor",contentEditable:!0,identifier:"editor",textContent:e.title,children:[{tagName:"br"},{tagName:"input",style:"width: 100%; margin-top: 10px",identifier:"time",type:"time"}]}]});class f extends i{onCreated(){const{planner:e,event:t,day:n}=this.properties;this.identifier.editor.addEventListener("input",(()=>{t.title=this.identifier.editor.textContent})),this.identifier.time.addEventListener("input",(e=>{const t=e.target.valueAsDate;t.setMonth(n.date.getMonth()),t.setDate(n.date.getDate()),t.setYear(n.date.getYear()),e.date=t}))}onRendered(){this.identifier.editor.focus()}}class y extends e{addEvent(e){if(this.properties.day.date==e.day){const t=new d(e.title,e.date);this.run(v(t),{binding:new f({event:t})})}}save(e){this.properties.planner.calendar.events.emit("add",e)}}class D extends i{constructor(e){super(e,new y(e.planner.calendar.events))}onCreated(){const{planner:e,day:t}=this.properties;this.root.addEventListener("click",(n=>{if(n.target==this.root){const n=e.calendar.addEvent("",t.date);this.run(v(n),{binding:new f({event:n})}),e.calendar.events.emit("added")}}));for(const n of e.calendar.events.byDate(t.date))this.run(v(n),{binding:new f({event:n})})}}var _=e=>({tagName:"div",className:`day${e.today?" current":""}${e.nextOrPreviousMonth?" grayed":""}`,children:[{tagName:"div",className:"date",textContent:e.date.getDate()},{model:g,binding:D}]});class w extends e{select(){this.root.classList.add("active")}unselect(){this.root.classList.remove("active")}}class b extends i{constructor(e){super(e,new w(e.day))}onCreated(){const{planner:e,day:t}=this.properties;e.calendar.events.byDate(t.date).length>=1&&this.root.classList.add("content"),this.root.addEventListener("click",(()=>e.calendar.emit("setDate",{date:t.date})))}}class N extends e{remove(){this.remove()}}class E extends i{constructor(e){super(e,new N(e.week))}onCreated(){const{planner:e,week:t}=this.properties;for(const e of t.days)this.run(_(e),{binding:new b({day:e})})}}class x extends e{setDate(e){const{planner:t}=this.properties,{calendar:n}=t,i=new Date(e.date);if(this.identifier.date.textContent=i.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),n.date.getMonth()!==i.getMonth()||n.date.getFullYear()!==i.getFullYear()||0==n.weeks.length||e.rebuild){null!==n.weeks&&n.weeks.forEach((e=>e.emit("remove"))),n.build(i);for(const e of n.weeks)this.run(m,{parentNode:this.identifier.weeks,binding:new E({week:e})})}else null!==n.weeks&&n.weeks.map((e=>e.days)).flat().forEach((e=>e.emit("unselect")));n.setDate(i),n.day.emit("select")}setYear(e){const{planner:t}=this.properties,{calendar:n}=t,i=new Date(n.date);i.setYear(e),n.emit("setDate",{date:i})}}var L={tagName:"div",id:"planner",children:[{tagName:"div",id:"navigation",identifier:"navigation",children:[{tagName:"button",identifier:"menuButton",title:"Menu",textContent:"⚙️"},{tagName:"div",className:"menu",identifier:"menu",children:[{tagName:"button",textContent:"Export",identifier:"export"},{tagName:"button",textContent:"Import",identifier:"import"}]}]},{model:p,binding:class extends i{constructor(e){super(e,new x(e.planner.calendar))}onCreated(){const{planner:e}=this.properties,{calendar:t}=e;this.listen(e,"imported",(()=>{t.emit("setDate",{date:t.date,rebuild:!0})})),t.emit("setDate",{date:t.date,rebuild:!0})}}}]};class M extends e{export(){const{planner:e}=this.properties;null!==this.textFileURL&&this.root.ownerDocument.defaultView.URL.revokeObjectURL(this.textFileURL);const t=new Blob([e.events.toString()],{type:"text/plain"}),n=new Date;this.textFileURL=URL.createObjectURL(t);const i=this.root.ownerDocument.createElement("a");i.href=this.textFileURL,i.download=`backup-domodel-planner-${n.getMonth()+1}-${n.getDate()}-${n.getFullYear()}.txt`,i.click(),e.emit("exported")}import(){const{planner:e}=this.properties,t=this.root.ownerDocument.createElement("input");t.type="file",t.style.display="none",t.addEventListener("input",(n=>{const i=new FileReader;i.addEventListener("load",(()=>{try{decryptedData.forEach((t=>e.events.add(t.content,new Date(t.date)))),e.emit("imported")}catch(e){console.error(e),alert("Unable to import this backup. It might be due to the current password not matching with the backup.")}})),i.addEventListener("error",(()=>alert("Error reading file"))),i.readAsText(n.target.files[0],"UTF-8"),t.remove()})),t.click()}openSettings(){this.popup.emit("show")}}class I extends i{static INACTIVITY_TIMER_DELAY=9e5;constructor(e){super(e,new M(e.planner)),this.textFileURL=null,this.interval=null,this.inactivity_timer_delay=this.properties.inactivity_timer_delay||I.INACTIVITY_TIMER_DELAY}onCreated(){const{planner:e}=this.properties;let t=!1;this.listen(e,"logout",(()=>{this.stopInactivityTimer()})),this.root.ownerDocument.defaultView.addEventListener("click",(()=>{this.restartInactivityTimer()})),this.root.ownerDocument.defaultView.addEventListener("input",(()=>{this.restartInactivityTimer()})),this.identifier.menuButton.addEventListener("click",(()=>{t?this.identifier.menu.classList.remove("opened"):this.identifier.menu.classList.add("opened"),t=!t})),this.identifier.export.addEventListener("click",(()=>e.emit("export"))),this.identifier.import.addEventListener("click",(()=>e.emit("import"))),this.startInactivityTimer()}startInactivityTimer(){this.interval=this.root.ownerDocument.defaultView.setInterval((()=>this.properties.planner.emit("logout")),this.inactivity_timer_delay)}stopInactivityTimer(){this.root.ownerDocument.defaultView.clearInterval(this.interval)}restartInactivityTimer(){this.stopInactivityTimer(),this.startInactivityTimer()}}const k="events";var O=e=>{const{planner:t}=e;if(t.firstRun=null===localStorage.getItem(k),0==t.firstRun){const e=JSON.parse(localStorage.getItem(k));for(const n of e)t.calendar.addEvent(n.title,new Date(n.date))}localStorage.getItem("currentDate")&&(t.calendar.date=new Date(localStorage.getItem("currentDate"))),t.calendar.listen("setDate",(()=>{localStorage.setItem("currentDate",t.calendar.date)})),t.calendar.events.listen("added",(()=>function(e){localStorage.setItem(k,e.calendar.events.toString())}(t))),t.listen("reset",(()=>localStorage.removeItem(k)))};window.addEventListener("load",(function(){const e=new h;O({planner:e}),s.run(L,{binding:new I({planner:e}),parentNode:document.body})}))}();
