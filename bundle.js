window.FOO="TEST",function(){"use strict";class e{constructor(e){this._observable=e}get observable(){return this._observable}}class t{constructor(e,t,i){this._observable=e,this._eventName=t,this._callback=i}remove(){this._observable.removeListener(this)}get eventName(){return this._eventName}get callback(){return this._callback}}class i{constructor(){this._listeners={}}listen(e,i,r=!1){Array.isArray(this._listeners[e])||(this._listeners[e]=[]);const n=new t(this,e,i);return r?this._listeners[e].unshift(n):this._listeners[e].push(n),n}removeListener(e){this._listeners[e.eventName]=this._listeners[e.eventName].filter((t=>t!==e))}emit(e,t){if(Array.isArray(this._listeners[e]))for(const i of this._listeners[e].slice())i.callback(t)}}class r{constructor(t,r=new e(new i)){this._identifier={},this._properties={...t},this._parent=null,this._root=null,this._model=null,this._children=[],this._listeners=[],this._eventListener=r}get identifier(){return this._identifier}get properties(){return this._properties}get root(){return this._root}get model(){return this._model}get eventListener(){return this._eventListener}listen(e,t,i,r=!1){const n=e.listen(t,i,r);return r?this._listeners.unshift(n):this._listeners.push(n),n}run(e,t){t.binding._parent=this,this._children.push(t.binding),t.binding._properties={...this.properties,...t.binding.properties},s.run(e,{parentNode:this.root,...t})}remove(){const e=this._listeners.slice();for(const t of e)t.remove();const t=this._children.slice();for(const e of t)e.remove();null!==this._parent&&(this._parent._children=this._parent._children.filter((e=>e!==this))),this.root.remove()}onCreated(){}async onRendered(){}}class n{static PROPERTIES=["tagName","children","identifier","model","binding","properties"];static METHOD={APPEND_CHILD:"APPEND_CHILD",INSERT_BEFORE:"INSERT_BEFORE",REPLACE_NODE:"REPLACE_NODE",WRAP_NODE:"WRAP_NODE",PREPEND:"PREPEND"};static run(e,{parentNode:t,binding:i=new r,method:s=n.METHOD.APPEND_CHILD}={}){const a=n.createNode(t,e,i);i._root=a,i._model=e;for(const e of Object.getOwnPropertyNames(Object.getPrototypeOf(i.eventListener)).filter((e=>"constructor"!==e&&"function"==typeof i.eventListener[e])))i.listen(i.eventListener.observable,e,i.eventListener[e].bind(i),!0);i.onCreated(),s===n.METHOD.APPEND_CHILD?t.appendChild(a):s===n.METHOD.INSERT_BEFORE?t.parentNode.insertBefore(a,t):s===n.METHOD.REPLACE_NODE?t.replaceWith(a):s===n.METHOD.WRAP_NODE?(a.appendChild(t.cloneNode(!0)),t.replaceWith(a)):s===n.METHOD.PREPEND&&t.prepend(a),i.onRendered()}static createNode(e,t,i){const{tagName:r,children:s=[]}=t,a=e.ownerDocument.createElement(r);Object.keys(t).filter((e=>!1===n.PROPERTIES.includes(e))).forEach((function(e){a[e]=t[e]}));for(const t of s)if(!0===Object.prototype.hasOwnProperty.call(t,"model")){let e;!0===Object.prototype.hasOwnProperty.call(t,"binding")&&(e=new t.binding({...i.properties,...t.properties}),!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=e)),i.run(t.model,{parentNode:a,binding:e})}else{const r=n.createNode(e,t,i);a.appendChild(r)}return!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=a),a}}var s=n;class a{constructor(e,t=r,i={}){this._definition=e,this._binding=t,this._properties=i}get definition(){return this._definition}get binding(){return this._binding}get properties(){return this._properties}}class o extends i{constructor(e){super(),this._number=e,this._days=[]}get number(){return this._number}get days(){return this._days}}class d extends i{constructor(e,t=!1){super(),this._date=e,this._previousMonth=t;const i=new Date;this._today=e.getMonth()===i.getMonth()&&e.getDate()===i.getDate()&&e.getFullYear()===i.getFullYear()}get date(){return this._date}get previousMonth(){return this._previousMonth}get today(){return this._today}}class h extends i{constructor(e,t){super(),this._title=e,this._date=t}get title(){return this._title}set title(e){this._title=e}get date(){return this._date}}class l extends i{constructor(){super(),this._list=[]}add(e,t){const i=new h(e,t);return this.list.push(i),i}remove(e){this.list.splice(this.list.indexOf(e),1)}update(e,t){for(const i in t)e[i]=t[i]}byDate(e){return this.list.filter((t=>t.date.getMonth()===e.getMonth()&&t.date.getFullYear()===e.getFullYear()&&t.date.getDate()===e.getDate()))}clear(){this._list=[]}get list(){return this._list}toString(){return JSON.stringify(this.list.map((e=>({title:e.title,date:e.date}))))}}class u extends i{constructor(e){super(),this._date=e,this._weeks=[],this._day=null,this._events=new l,this.build(e)}getDayByDate(e){return this.weeks.map((e=>e.days)).flat().find((t=>t.date.getDate()===e.getDate()&&t.date.getMonth()===e.getMonth()))}build(e){this.weeks=[];const t=new Date(e.getFullYear(),e.getMonth()+1,0).getDate(),i=new Date(e.getFullYear(),e.getMonth()),r=[...Array(t).keys()];let n=new o(1);for(let t=i.getDay();t>0;t--){const i=new Date(e);i.setMonth(e.getMonth()-1);const r=new Date(i.getFullYear(),i.getMonth()+1,0).getDate();i.setDate(r-t+1),n.days.push(new d(i,!0))}for(let t=1;t<r.length+1;t++){const i=new Date(e);i.setDate(t),n.days.push(new d(i)),7!==n.days.length&&t!==r.length||(this.weeks.push(n),n=new o(n.number+1))}}setDate(e){this.date=e,this.day=this.getDayByDate(e)}addEvent(e,t){return this.events.add(e,t)}get date(){return this._date}set date(e){this._date=e}get day(){return this._day}set day(e){this._day=e}get weeks(){return this._weeks}set weeks(e){this._weeks=e}get events(){return this._events}}class c extends i{constructor(e=new Date){super(),this._calendar=new u(e),this._firstRun=!0}get calendar(){return this._calendar}get editor(){return this._editor}get events(){return this._events}get firstRun(){return this._firstRun}set firstRun(e){this._firstRun=e}}var p={tagName:"div",style:"display: contents"},g={tagName:"div",className:"router",identifier:"view"};class m{static TYPE={PATH:"PATH",PARAMETER:"PARAMETER",SEPARATOR:"SEPARATOR"};constructor(e,t,i){this._type=e,this._buffer=t,this._bufferIndex=i}get type(){return this._type}get buffer(){return this._buffer}get bufferIndex(){return this._bufferIndex}}class f{static SEPARATOR="/";static PARAMETER_PREFIX="{";static PARAMETER_SUFFIX="}";static tokenize(e){const t=[],i=[...e];let r="";for(const[e,n]of i.entries()){r+=n;const s=e-r.length+1;if(r[0]===f.PARAMETER_PREFIX&&n===f.PARAMETER_SUFFIX){if(1===r.length)continue;t.push(new m(m.TYPE.PARAMETER,r,s)),r=""}else if(r[0]===f.PARAMETER_PREFIX){if(1===r.length)continue;n===f.SEPARATOR?(t.push(new m(m.TYPE.PATH,r.slice(-1),s)),t.push(new m(m.TYPE.SEPARATOR,n,s-r.length)),r=""):e===i.length-1&&t.push(new m(m.TYPE.PATH,r,s))}else if(n===f.SEPARATOR)t.push(new m(m.TYPE.SEPARATOR,r,s)),r="";else{const e=t[t.length-1];e&&e.type===m.TYPE.PATH?t[t.length-1]=new m(m.TYPE.PATH,e.buffer+r,e.bufferIndex):t.push(new m(m.TYPE.PATH,r,s)),r=""}}return t}}class y{constructor({match:e,model:t,middleware:i,layout:r}={}){this._match=e,this._model=t,this._middleware=i,this._layout=r}get match(){return this._match}get model(){return this._model}get middleware(){return this._middleware}get layout(){return this._layout}}class _{constructor(e,t={}){this._route=e,this._parameters=t}get route(){return this._route}get parameters(){return this._parameters}}var v=e=>({tagName:"div",textContent:`No route was found for path "${e.router.path}"`});class w extends i{static TYPE={VIRTUAL:"VIRTUAL",PATHNAME:"PATHNAME",HASH:"HASH"};constructor({routes:e,type:t=w.TYPE.VIRTUAL,errorRoute:i,initialPath:r="/",defaultLayout:n,basePath:s=""}={}){super(),this._routes=e,this._type=t,this._errorRoute=i||new y({model:new a(v)}),this._initialPath=r,this._view=null,this._path=null,this._defaultLayout=n,this._basePath=s}match(e){const t=f.tokenize(e);"/"===t[t.length-1]?.buffer&&t.pop();for(const e of this.routes){const i=[],r=f.tokenize(e.match);if("/"===r[r.length-1]?.buffer&&r.pop(),r.length===t.length){for(const[e,n]of t.entries())(r[e].buffer===n.buffer||r[e].type===m.TYPE.SEPARATOR||r[e].type===m.TYPE.PARAMETER&&n.type===m.TYPE.PATH)&&i.push(r[e]);if(i.length===t.length){const i={};for(const[e,n]of t.entries())r[e].type===m.TYPE.PARAMETER&&n.type===m.TYPE.PATH&&(i[r[e].buffer.slice(1,-1)]=decodeURIComponent(n.buffer));return new _(e,i)}}}return null}get routes(){return this._routes}get type(){return this._type}get errorRoute(){return this._errorRoute}get initialPath(){return this._initialPath}get view(){return this._view}get path(){return this._path}get defaultLayout(){return this._defaultLayout}get basePath(){return this._basePath}}class E extends i{constructor(e={}){super(),this._parameters=e}get parameters(){return this._parameters}get binding(){return this._binding}set binding(e){this._binding=e}}class b{constructor(e,t={}){this._path=e,this._properties=t}get path(){return this._path}get properties(){return this._properties}}class D extends e{navigate(e){let t=e.path;this.properties.router.type===w.TYPE.HASH&&(t=`#${e.path}`),this.root.ownerDocument.defaultView.history.pushState({},null,`${this.properties.router.basePath}${t}`),this.properties.router.emit("browse",e)}browse(e){const t=this.properties.router.match(e.path);if(t){if(t.route.middleware&&t.route.middleware(this.properties))return;this.properties.router.emit("routeSet",{match:t,link:e})}else this.properties.router.emit("routeSet",{match:new _(this.properties.router.errorRoute),link:new b(e.path,{path:e.path})})}routeSet(e){const{match:t,link:i}=e;null!==this.properties.router.view&&(this.layoutBinding?(this.layoutBinding.remove(),this._layoutBinding=null):this.properties.router.view.binding.remove()),this.properties.router._path=i.path,this.properties.router._view=new E(t.parameters),this.properties.router.view.binding=new t.route.model.binding({...this.properties,...t.route.model.properties,...i.properties});let r=t.route.model.definition({...this.properties,...t.route.model.properties,...i.properties}),n=this;t.route.layout?(n=new t.route.layout.binding(t.route.layout.properties),this.run(t.route.layout.definition,{binding:n})):this.properties.router.defaultLayout&&(n=new this.properties.router.defaultLayout.binding(this.properties.router.defaultLayout.properties),this.run(this.properties.router.defaultLayout.definition,{binding:n})),n!==this&&(this._layoutBinding=n),n.run(r,{parentNode:n.identifier.view,binding:this.properties.router.view.binding})}}class P extends r{constructor(e){super(e,new D(e.router))}onCreated(){const{router:e}=this.properties;if(this.root.ownerDocument.defaultView.addEventListener("popstate",(()=>{if(e.type===w.TYPE.HASH){let t=this.root.ownerDocument.location.hash.slice(1);""===t?e.emit("navigate",new b("/")):e.emit("browse",new b(t))}else e.type===w.TYPE.PATHNAME&&e.emit("browse",new b(this.root.ownerDocument.location.pathname.slice(e.basePath.length)))})),null!==e.initialPath)if(e.type===w.TYPE.VIRTUAL)e.emit("browse",new b(e.initialPath));else{let t;e.type===w.TYPE.PATHNAME&&"/"!==this.root.ownerDocument.location.pathname.slice(e.basePath.length)?t=this.root.ownerDocument.location.pathname.slice(e.basePath.length):e.type===w.TYPE.HASH&&""!==this.root.ownerDocument.location.hash.slice(1)&&(t=this.root.ownerDocument.location.hash.slice(1)),t?e.emit("browse",new b(t)):e.emit("navigate",new b(e.initialPath))}}get path(){return this._path}get view(){return this._view}get layoutBinding(){return this._layoutBinding}}class N extends e{reset(){const{diary:e}=this.properties;e.firstRun=!0}}var R={tagName:"div",className:"date-browser",children:[{tagName:"div",children:[{tagName:"button",identifier:"today",textContent:"↩️"}]},{tagName:"div",className:"controls",children:[{tagName:"div",children:[{tagName:"button",identifier:"previousMonth",textContent:"←"},{tagName:"select",identifier:"month",children:["January","February","March","April","May","June","July","August","September","October","November","December"].map(((e,t)=>({tagName:"option",value:t+1,textContent:e})))},{tagName:"button",identifier:"nextMonth",textContent:"→"}]},{tagName:"input",type:"number",identifier:"year"}]}]};var T={tagName:"div",id:"calendar",children:[{tagName:"h2",identifier:"date",id:"date"},{model:R,binding:class extends r{onCreated(){const{diary:e}=this.properties,{calendar:t}=e;t.listen("setDate",(e=>{const t=new Date(e.date);this.identifier.month.selectedIndex=t.getMonth(),this.identifier.year.value=t.getFullYear()})),this.identifier.today.addEventListener("click",(e=>t.emit("setDate",{date:new Date}))),this.identifier.month.addEventListener("change",(e=>t.emit("setDate",{date:this.getCurrentMonthDate(),rebuild:!0}))),this.identifier.previousMonth.addEventListener("click",(()=>t.emit("setDate",{date:this.getPreviousMonthDate(),rebuild:!0}))),this.identifier.nextMonth.addEventListener("click",(()=>t.emit("setDate",{date:this.getNextMonthDate(),rebuild:!0}))),this.identifier.year.addEventListener("input",(e=>t.emit("setYear",e.target.value)))}getDateByMonthIndex(e){const t=this.properties.diary.calendar.date;return e>this.identifier.month.options.length-1?(e=0,t.setYear(parseInt(this.identifier.year.value)+1)):e<0&&(e=0,t.setYear(this.identifier.year.value-1)),t.setMonth(e),t}getNextMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex+1)}getPreviousMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex-1)}getCurrentMonthDate(){return this.getDateByMonthIndex(this.identifier.month.selectedIndex)}}},{tagName:"div",id:"day-headers",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((e=>({tagName:"div",className:"day-header padding-2xs",textContent:e})))},{tagName:"div",identifier:"weeks",id:"weeks"}]},A={className:"week",tagName:"div"},x={tagName:"div",className:"events"},M=e=>({tagName:"div",className:"event",children:[{identifier:"remove",tagName:"div",className:"actions",children:[{tagName:"button",textContent:"⚙️"}]},{tagName:"div",className:"editor",contentEditable:!0,identifier:"editor",textContent:e.title,children:[{tagName:"br"},{tagName:"input",style:"width: 100%; margin-top: 10px",identifier:"time",type:"time"}]}]});class L extends r{onCreated(){const{diary:e,event:t,day:i}=this.properties;this.identifier.editor.addEventListener("input",(()=>{t.title=this.identifier.editor.textContent})),this.identifier.time.addEventListener("input",(e=>{const t=e.target.valueAsDate;t.setMonth(i.date.getMonth()),t.setDate(i.date.getDate()),t.setYear(i.date.getYear()),e.date=t}))}onRendered(){this.identifier.editor.focus()}}class I extends e{addEvent(e){if(this.properties.day.date==e.day){const t=new h(e.title,e.date);this.run(M(t),{binding:new L({event:t})})}}save(e){this.properties.diary.calendar.events.emit("add",e)}}class k extends r{constructor(e){super(e,new I(e.diary.calendar.events))}onCreated(){const{diary:e,day:t}=this.properties;this.root.addEventListener("click",(i=>{if(i.target==this.root){const i=e.calendar.addEvent("",t.date);this.run(M(i),{binding:new L({event:i})}),e.calendar.events.emit("added")}}));for(const i of e.calendar.events.byDate(t.date))this.run(M(i),{binding:new L({event:i})})}}var O=e=>({tagName:"div",className:`day${e.today?" current":""}${e.previousMonth?" grayed":""}`,children:[{tagName:"div",className:"date",textContent:e.date.getDate()},{model:x,binding:k}]});class Y extends e{select(){}unselect(){}}class C extends r{constructor(e){super(e,new Y(e.day))}onCreated(){const{diary:e,day:t}=this.properties;e.calendar.events.byDate(t.date).length>=1&&this.root.classList.add("content"),this.root.addEventListener("click",(()=>e.calendar.emit("setDate",{date:t.date})))}}class S extends e{remove(){this.remove()}}class H extends r{constructor(e){super(e,new S(e.week))}onCreated(){const{diary:e,week:t}=this.properties;for(const e of t.days)this.run(O(e),{binding:new C({day:e})})}}class F extends e{setDate(e){const{diary:t}=this.properties,{calendar:i}=t,r=new Date(e.date);if(this.identifier.date.textContent=r.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),i.date.getMonth()!==r.getMonth()||i.date.getFullYear()!==r.getFullYear()||0==i.weeks.length||e.rebuild){null!==i.weeks&&i.weeks.forEach((e=>e.emit("remove"))),i.build(r);for(const e of i.weeks)this.run(A,{parentNode:this.identifier.weeks,binding:new H({week:e})})}else null!==i.weeks&&i.weeks.map((e=>e.days)).flat().forEach((e=>e.emit("unselect")));i.setDate(r),i.day.emit("select")}setYear(e){const{diary:t}=this.properties,{calendar:i}=t,r=new Date(i.date);r.setYear(e),i.emit("setDate",{date:r})}}class B extends r{constructor(e){super(e,new F(e.diary.calendar))}onCreated(){const{diary:e}=this.properties,{calendar:t}=e;this.listen(e,"imported",(()=>{t.emit("setDate",{date:t.date,rebuild:!0})})),t.emit("setDate",{date:t.date,rebuild:!0})}}var U=e=>({tagName:"div",id:"diary",style:"display: contents",children:[{tagName:"div",id:"navigation",identifier:"navigation",children:[{tagName:"button",identifier:"menuButton",title:"Menu",textContent:"⚙️"},{tagName:"div",className:"menu",identifier:"menu",children:[{tagName:"button",textContent:"Export",identifier:"export"},{tagName:"button",textContent:"Import",identifier:"import"}]}]},{model:T,binding:B}]});class V extends e{export(){const{diary:e}=this.properties;null!==this.textFileURL&&this.root.ownerDocument.defaultView.URL.revokeObjectURL(this.textFileURL);const t=new Blob([e.events.toString()],{type:"text/plain"}),i=new Date;this.textFileURL=URL.createObjectURL(t);const r=this.root.ownerDocument.createElement("a");r.href=this.textFileURL,r.download=`backup-domodel-diary-${i.getMonth()+1}-${i.getDate()}-${i.getFullYear()}.txt`,r.click(),e.emit("exported")}import(){const{diary:e}=this.properties,t=this.root.ownerDocument.createElement("input");t.type="file",t.style.display="none",t.addEventListener("input",(i=>{const r=new FileReader;r.addEventListener("load",(()=>{try{decryptedData.forEach((t=>e.events.add(t.content,new Date(t.date)))),e.emit("imported")}catch(e){console.error(e),alert("Unable to import this backup. It might be due to the current password not matching with the backup.")}})),r.addEventListener("error",(()=>alert("Error reading file"))),r.readAsText(i.target.files[0],"UTF-8"),t.remove()})),t.click()}openSettings(){this.popup.emit("show")}}class j extends r{static INACTIVITY_TIMER_DELAY=9e5;constructor(e){super(e,new V(e.router.view)),this.textFileURL=null,this.interval=null,this.inactivity_timer_delay=this.properties.inactivity_timer_delay||j.INACTIVITY_TIMER_DELAY}onCreated(){const{diary:e,router:t}=this.properties;let i=!1;this.listen(e,"logout",(()=>{this.stopInactivityTimer()})),this.root.ownerDocument.defaultView.addEventListener("click",(()=>{this.restartInactivityTimer()})),this.root.ownerDocument.defaultView.addEventListener("input",(()=>{this.restartInactivityTimer()})),this.identifier.menuButton.addEventListener("click",(()=>{i?this.identifier.menu.classList.remove("opened"):this.identifier.menu.classList.add("opened"),i=!i})),this.identifier.export.addEventListener("click",(()=>t.view.emit("export"))),this.identifier.import.addEventListener("click",(()=>t.view.emit("import"))),this.startInactivityTimer()}startInactivityTimer(){this.interval=this.root.ownerDocument.defaultView.setInterval((()=>this.properties.diary.emit("logout")),this.inactivity_timer_delay)}stopInactivityTimer(){this.root.ownerDocument.defaultView.clearInterval(this.interval)}restartInactivityTimer(){this.stopInactivityTimer(),this.startInactivityTimer()}}class $ extends r{constructor(e){super(e,new N(e.diary)),this.router=new w({routes:[new y({match:"/",model:new a(U,j)})]})}onCreated(){this.run(g,{binding:new P({router:this.router})})}get router(){return this._router}set router(e){this._router=e}}const W="events";var J=e=>{const{diary:t}=e;if(t.firstRun=null===localStorage.getItem(W),0==t.firstRun){const e=JSON.parse(localStorage.getItem(W));for(const i of e)t.calendar.addEvent(i.title,new Date(i.date))}t.calendar.events.listen("added",(()=>function(e){localStorage.setItem(W,e.calendar.events.toString())}(t))),t.listen("reset",(()=>localStorage.removeItem(W)))};window.addEventListener("load",(function(){const e=new c;J({diary:e}),s.run(p,{binding:new $({diary:e}),parentNode:document.body})}))}();
